<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD 系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.0/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.0/js/jquery.dataTables.js"></script>
    <style>
        .photo-preview { max-width: 50px; max-height: 50px; object-fit: cover; }
        .edit-delete-btns { display: flex; gap: 5px; }
        .selected { background-color: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>即時更新的 CRUD 系統</h1>
        <form id="dataForm">
            <!-- 改為輸入圖片 URL -->
            <input type="text" id="photoURLInput" class="form-control mb-2" placeholder="輸入圖片URL">
            <img id="photoPreview" class="photo-preview mb-2" style="display:none;">
            <input type="text" id="nameInput" class="form-control mb-2" placeholder="輸入名稱">
            <input type="number" id="priceInput" class="form-control mb-2" placeholder="輸入價格">
            <button type="submit" class="btn btn-primary">新增</button>
            <button type="button" class="btn btn-info update-btn" style="display:none;">更新</button>
            <button type="button" class="btn btn-secondary">取消</button>
            <!-- 新增儲存按鈕 -->
            <button type="button" class="btn btn-success" id="saveBtn">儲存資料</button>
        </form>
        <table class="table mt-4">
            <thead>
                <tr>
                    <th>照片</th>
                    <th>名稱</th>
                    <th>價格</th>
                    <th>標籤</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        $(document).ready(function() {
            var table = $('.table').DataTable();
            loadDataFromLocalStorage(); // 頁面加載時自動載入數據

            // 當使用者輸入圖片URL時即時顯示預覽
            $('#photoURLInput').on('input', function() {
                var photoURL = $(this).val();
                if (photoURL) {
                    $('#photoPreview').attr('src', photoURL).show();
                } else {
                    $('#photoPreview').hide();
                }
            });

            // 提交表單新增資料
            $('#dataForm').on('submit', function(e) {
                e.preventDefault();
                addData();
            });

            function addData() {
                var name = $('#nameInput').val();
                var price = $('#priceInput').val();
                var photoURL = $('#photoURLInput').val(); // 獲取用戶輸入的圖片URL

                // 確定提供了有效的URL
                if (!photoURL) {
                    alert('請提供圖片的URL');
                    return;
                }

                // 發送POST請求到後端  //要填上api!!!
                fetch('https://your-api-endpoint.com/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        price: price,
                        photo: photoURL  // 使用图片URL
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // 如果數據添加成功，更新前端的表格
                    var rowNode = table.row.add([ 
                        '<img src="' + photoURL + '" class="photo-preview">',  // 使用URL顯示圖片
                        name,
                        price,
                        '<div class="edit-delete-btns"><button class="btn btn-warning btn-sm">編輯</button> <button class="btn btn-danger btn-sm">刪除</button></div>'
                    ]).draw(false).node();
                    
                    saveToLocalStorage(); // 將數據保存到localStorage
                    resetForm(); // 重置表單
                })
                .catch(error => {
                    console.error('Error adding data:', error);
                    alert('資料新增失敗，請稍後再試');
                });
            }

            // 儲存數據到 localStorage
            function saveToLocalStorage() {
                var data = [];
                table.rows().every(function() {
                    var $row = $(this.node());
                    data.push({
                        photo: $row.find('img').attr('src'),
                        name: $row.children('td').eq(1).text(),
                        price: $row.children('td').eq(2).text()
                    });
                });
                localStorage.setItem('crudData', JSON.stringify(data)); // 儲存資料
            }

            // 從 localStorage 載入資料
            function loadDataFromLocalStorage() {
                var data = JSON.parse(localStorage.getItem('crudData')) || [];
                data.forEach(function(item) {
                    table.row.add([ // 添加從 localStorage 載入的數據
                        '<img src="' + item.photo + '" class="photo-preview">',  // 使用URL显示图片
                        item.name,
                        item.price,
                        '<div class="edit-delete-btns"><button class="btn btn-warning btn-sm">編輯</button> <button class="btn btn-danger btn-sm">刪除</button></div>'
                    ]).draw(false);
                });
            }

            // 編輯資料
            $('.table tbody').on('click', '.btn-warning', function() {
                var row = table.row($(this).parents('tr')).node();
                editData(row);
            });

            function editData(row) {
                var $row = $(row);
                $('#photoURLInput').val($row.find('img').attr('src'));
                $('#photoPreview').attr('src', $row.find('img').attr('src')).show();
                $('#nameInput').val($row.children('td').eq(1).text());
                $('#priceInput').val($row.children('td').eq(2).text());
                $('.update-btn').show();
                $('button[type="submit"]').hide();
                $row.addClass('selected');
            }

            // 更新資料
            $('.update-btn').on('click', function() {
                var selectedRow = $('.table tbody tr.selected');
                if (selectedRow.length) {
                    var rowIdx = table.row(selectedRow).index();
                    
                    var updatedData = {
                        name: $('#nameInput').val(),
                        price: $('#priceInput').val(),
                        photo: $('#photoURLInput').val()  // 獲取圖片網址
                    };

                    if (!updatedData.photo) {
                        alert('請提供圖片的URL');
                        return;
                    }

                    // 發送PUT請求到後端  //要填上api!!!
                    fetch(`https://your-api-endpoint.com/items/${rowIdx}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 更新表格
                        table.row(rowIdx).data([
                            '<img src="' + updatedData.photo + '" class="photo-preview">',  // 使用URL更新圖片
                            updatedData.name,
                            updatedData.price,
                            '<div class="edit-delete-btns"><button class="btn btn-warning btn-sm">編輯</button> <button class="btn btn-danger btn-sm">刪除</button></div>'
                        ]).draw(false);
                        saveToLocalStorage(); // 保存更新至 localStorage
                        resetForm(); // 重製表單
                    })
                    .catch(error => {
                        console.error('Error updating data:', error);
                        alert('資料更新失敗，請稍後再試');
                    });
                }
            });

            // 刪除資料
            $('.table tbody').on('click', '.btn-danger', function() {
                if (confirm('確定刪除這筆資料？')) {
                    table.row($(this).parents('tr')).remove().draw();
                    saveToLocalStorage(); // 刪除後更新 localStorage
                }
            });

            // 取消編輯
            $('button.btn-secondary').on('click', resetForm);

            // 重置表單
            function resetForm() {
                $('#dataForm')[0].reset();
                $('#photoPreview').hide();
                $('.update-btn').hide();
                $('button[type="submit"]').show();
                $('.table tbody tr.selected').removeClass('selected');
            }

            // 當按下 "儲存資料" 按鈕時，儲存所有資料到 localStorage
            $('#saveBtn').on('click', function() {
                saveToLocalStorage();
                alert('資料已儲存！');
            });
        });
    </script>
</body>
</html>
